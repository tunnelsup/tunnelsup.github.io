<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: troubleshooting | TunnelsUP]]></title>
  <link href="https://www.tunnelsup.com/tup/tag/troubleshooting/atom.xml" rel="self"/>
  <link href="https://www.tunnelsup.com/"/>
  <updated>2018-05-14T12:33:15-07:00</updated>
  <id>https://www.tunnelsup.com/</id>
  <author>
    <name><![CDATA[Jack]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Cisco ASA Drop Reason: Unexpected-Packet]]></title>
    <link href="https://www.tunnelsup.com/cisco-asa-drop-reason-unexpected-packet/"/>
    <updated>2017-05-23T21:05:00-07:00</updated>
    <id>https://www.tunnelsup.com/cisco-asa-drop-reason-unexpected-packet</id>
    <content type="html"><![CDATA[<p>Today I was trying to send management traffic over a VPN tunnel to a Cisco ASA that terminated the tunnel. I ran into some problems doing this and I want to document my troubleshooting steps.</p>

<h3>Config</h3>

<p>Before attempting to ssh to the ASA I made sure that ssh to the ASA worked when coming from the inside of the network.</p>

<p>Then I applied the config:</p>

<p><code>
ssh 10.0.0.0 255.0.0.0 INSIDE
management-access INSIDE
</code></p>

<p>Even though we are coming from the OUTSIDE, when it comes over the VPN tunnel we can get into the ASA through the INSIDE interface. Going over the VPN tunnel for ssh is more secure than doing it directly over the Internet. This also means you&rsquo;ll be sshing to the IP that is on the INSIDE of your ASA.</p>

<h3>Errors</h3>

<p>Well this didn&rsquo;t work and to see the drop reason we can do a asp-drop capture like this:</p>

<p><code>cap cap1 type asp-drop all</code></p>

<p>Then I looked at the cap including just the IP I was after and saw this:</p>

<p><code>
ASA5508# sh cap cap1 | i 192.168.128.5
   9: 17:40:03.527957       10.50.101.6 &gt; 192.168.128.5: icmp: echo request Drop-reason: (unexpected-packet) Unexpected packet
  10: 17:40:03.641858       10.2.11.50.49955 &gt; 192.168.128.5.161:  udp 75 Drop-reason: (unexpected-packet) Unexpected packet
  17: 17:40:05.520206       10.50.101.6 &gt; 192.168.128.5: icmp: echo request
  24: 17:40:07.320402       10.2.11.50 &gt; 192.168.128.5: icmp: echo request Drop-reason: (unexpected-packet) Unexpected packet
  58: 17:40:22.546907       10.50.101.6.1030 &gt; 192.168.128.5.22: S 1027314954:1027314954(0) win 4128 &lt;mss 536&gt; Drop-reason: (unexpected-packet) Unexpected packet
  64: 17:40:24.540224       10.50.101.6.1030 &gt; 192.168.128.5.22: S 1027314954:1027314954(0) win 4128 &lt;mss 536&gt; Drop-reason: (unexpected-packet) Unexpected packet
  67: 17:40:25.106302       10.2.11.50.39489 &gt; 192.168.128.5.161:  udp 41 Drop-reason: (unexpected-packet) Unexpected packet
  77: 17:40:28.541292       10.50.101.6.1030 &gt; 192.168.128.5.22: S 1027314954:1027314954(0) win 4128 &lt;mss 536&gt; Drop-reason: (unexpected-packet) Unexpected packet
  84: 17:40:30.111276       10.2.11.50.39489 &gt; 192.168.128.5.161:  udp 41 Drop-reason: (unexpected-packet) Unexpected packet
</code></p>

<p>Now we have narrowed down this issue to be a drop reason of &ldquo;unexpected-packet&rdquo;.</p>

<h3>Fix</h3>

<p><a href="http://www.cisco.com/c/en/us/td/docs/security/asa/asa-command-reference/show_asp_drop/show_asp_drop.html">Cisco Writes:</a></p>

<blockquote><p>Unexpected-Packet occurs when the appliance in transparent mode receives a non-IP packet, destined to its MAC address, but there is no corresponding service running on the appliance to process the packet.</p></blockquote>

<p>But in my case this is neither a non-IP packet, nor is this firewall in transparent mode. So because Cisco is flat out wrong here, a blog post was obligatory.</p>

<p>We actually need to take a look at our <strong>NAT</strong> commands. Specifically adding the <code>route-lookup</code> option to our NAT.</p>

<p>My <strong>NONAT</strong> statement looked like this:</p>

<p><code>nat (INSIDE,any) source static LOCAL-NETS LOCAL-NETS destination static REMOTE-NETS REMOTE-NETS</code></p>

<p>This was changed to become:</p>

<p><code>nat (INSIDE,any) source static LOCAL-NETS LOCAL-NETS destination static REMOTE-NETS REMOTE-NETS route-lookup</code></p>

<p>After that, the ssh worked.</p>

<h3>Reason</h3>

<p><a href="http://www.cisco.com/c/en/us/td/docs/security/asa/asa-command-reference/I-R/cmdref2/n.html">Cisco Writes the route-lookup command:</a></p>

<blockquote><p>For identity NAT in routed mode, determines the egress interface using a route lookup instead of using the interface specified in the NAT command. If you do not specify interfaces in the NAT command, a route lookup is used by default.</p></blockquote>

<p>That means, if you have <code>any</code> in your NAT statement, the ASA isn&rsquo;t sure what interface to route the packet to (yes, even though the ASA HAS this IP on it&rsquo;s interface). By adding <code>route-lookup</code> the ASA decides to check the routing table to determine what interface to send the packet to.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cisco ASA command to show listening ports]]></title>
    <link href="https://www.tunnelsup.com/cisco-asa-command-to-show-listening-ports/"/>
    <updated>2016-09-29T15:05:00-07:00</updated>
    <id>https://www.tunnelsup.com/cisco-asa-command-to-show-listening-ports</id>
    <content type="html"><![CDATA[<p>Do you wish there was a <code>netstat</code> command for a Cisco ASA? Are you looking to see what ports the ASA has open and is listening on? Try this command:</p>

<p>```
ASA5506# sh asp table socket</p>

<p>Protocol  Socket    State      Local Address        Foreign Address
SSL       0001ebf8  LISTEN     172.16.3.1:443       0.0.0.0:<em>
TCP       000216f8  LISTEN     172.16.3.1:22        0.0.0.0:</em>
TCP       370c1d68  LISTEN     99.99.99.99:22       0.0.0.0:*
TCP       3712d678  ESTAB      172.16.3.1:22        172.16.2.3:50233
```</p>

<p>This command displays all of the ports that are open and established on the ASA.</p>

<p>The <code>state</code> indicates whether the port is listening or established.</p>

<p>The <code>local address</code> says which IP it&rsquo;s listening on. In the example above, 99.99.99.99 is the outside interface and the 172.16.3.1 is the inside interface.</p>

<p>The <code>foreign address</code> will show up when someone connects to that port. In this case I was ssh&rsquo;d into the firewall coming from 172.16.2.3.</p>

<p>The output above should be a direct reflection of the <code>ssh</code>, <code>telnet</code>, and <code>http</code> commands in the ASA.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to show and clear user sessions on a Cisco ASA]]></title>
    <link href="https://www.tunnelsup.com/how-to-show-and-clear-user-sessions-on-a-cisco-asa/"/>
    <updated>2016-06-18T16:36:00-07:00</updated>
    <id>https://www.tunnelsup.com/how-to-show-and-clear-user-sessions-on-a-cisco-asa</id>
    <content type="html"><![CDATA[<p>Sometimes you need to disconnect someone&rsquo;s ssh session to a Cisco ASA. This may be needed because users haven&rsquo;t logged out properly and have taken up all the sessions allowed.</p>

<h2>Check Usage Limits</h2>

<p>You can check usage limits by seeing how many sessions the ASA <em>thinks</em> are connected.</p>

<p><code>
FWL1# show resource usage resource ssh
Resource                 Current        Peak      Limit        Denied Context
SSH Server                     5           5          5           109 System
</code></p>

<p>In this case the ASA can only connect 5 years and it thinks there are 5 sessions open and therefore it cannot connect any more.</p>

<p>There&rsquo;s a bug that doesn&rsquo;t properly release sessions from the ASA. <a href="https://bst.cloudapps.cisco.com/bugsearch/bug/CSCsm68097">https://bst.cloudapps.cisco.com/bugsearch/bug/CSCsm68097</a></p>

<h2>Show current ssh sessions</h2>

<p>To display all ssh sessions connected run this command.</p>

<p>```
FWL1# show ssh sessions                      <br/>
SID Client IP       Version Mode Encryption Hmac     State            Username
0   10.1.1.21       2.0     IN   aes128-ctr sha1     SessionStarted   james</p>

<pre><code>                        OUT  aes128-ctr sha1     SessionStarted   james
</code></pre>

<p>2   10.1.1.22       2.0     IN   aes128-ctr sha1     SessionStarted   frank</p>

<pre><code>                        OUT  aes128-ctr sha1     SessionStarted   frank
</code></pre>

<p>3   10.1.1.20       2.0     IN   aes128-ctr sha1     SessionStarted   henry</p>

<pre><code>                        OUT  aes128-ctr sha1     SessionStarted   henry
</code></pre>

<p>```</p>

<h2>Disconnect user</h2>

<p>If you want to disconnect user henry, find the SID and use this command:</p>

<p><code>
FWL1# ssh disconnect 3
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cisco ASA TCP Randomization Issue]]></title>
    <link href="https://www.tunnelsup.com/cisco-asa-tcp-randomization-issue/"/>
    <updated>2016-03-29T23:21:00-07:00</updated>
    <id>https://www.tunnelsup.com/cisco-asa-tcp-randomization-issue</id>
    <content type="html"><![CDATA[<p>You may sometimes see this syslog message from a Cisco ASA:</p>

<p><code>%ASA-4-419002: Received duplicate TCP SYN from in_interface : src_address / src_port to out_interface : dest_address / dest_port with different initial sequence number.</code></p>

<p>I see this a lot on VPN firewalls where packets are dropped due to the sequence numbers not being correct in TCP.  This happens when the ASA randomizes the TCP sequence numbers and another device is also performing the same randomization of the TCP sequence numbers.</p>

<p>One way to bypass this is to disable TCP Sequence Number randomization on the ASA.  This can be done on a selective basis.  (NOTE:  You may need this as well as Option 19 permissions if you are putting BGP through the firewall).</p>

<p>Here is a sample conf to disable TCP randomization for a specific subnet:</p>

<p>```
access-list ACL-SEQUENCE-NUMBER extended permit tcp vpn-ip-pool any
access-list ACL-SEQUENCE-NUMBER extended permit tcp any vpn-ip-pool</p>

<p>class-map CM-SEQUENCE-NUMBER
  match access-list ACL-SEQUENCE-NUMBER</p>

<p>policy-map global_policy
class CM-SEQUENCE-NUMBER
  set connection random-sequence-number disable
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cisco Nexus Packet Captures with Ethanalyzer]]></title>
    <link href="https://www.tunnelsup.com/cisco-ios-packet-captures-with-ethanalyzer/"/>
    <updated>2015-11-11T22:46:00-08:00</updated>
    <id>https://www.tunnelsup.com/cisco-ios-packet-captures-with-ethanalyzer</id>
    <content type="html"><![CDATA[<p>There is a lesser known built in packet capture tool in Nexus OS called Ethanalyzer.</p>

<p>Valid for Nexus models
7k, 6k, 5k, 3k, 1kv</p>

<p><a href="/packet-captures-on-cisco-asa/">How to do packet captures on a Cisco ASA</a></p>

<p><a href="/packet-capture-for-cisco-ios-router/">How to do packet capture on Cisco IOS Router</a></p>

<h2>Capturing packets on the data-plane</h2>

<p>To capture specific IP flows.</p>

<p>Any traffic that is logged in an interface ACL can then be seen in the ethanalyzer.</p>

<p>```
ip access-list ACL-CAPTURE
permit ip 10.0.0.250/32 10.1.7.250/32 log
permit ip any any</p>

<p>int vlan 50
  ip access-group ACL-CAPTURE in</p>

<p>ethanalyzer local interface inband display-filter ip.src==10.0.0.250 limit-captured-frames 50
```</p>

<ul>
<li>Use <a href="http://packetlife.net/media/library/13/Wireshark_Display_Filters.pdf">wireshark display-filters</a>! This will change what’s displayed.</li>
<li>Use capture filters to change what is captured</li>
<li>Command only available from the default VDC.</li>
</ul>


<p>Use this command to create a pcap</p>

<p><code>
ethanalyzer local interface inband write MYCAPTURE.pcap display-filter ip.src==10.0.0.250 limit-captured-frames 50
</code></p>

<p>This will save the pcap file to the nexus which you can then use the <code>copy flash ftp</code> command to move it off the device.</p>

<h3>Limitation</h3>

<p>It only runs in the default VDC. If you do not have access to the admin or default VDC you cannot use this command. You can still capture from another VDC by setting an interface ACL and log the traffic you want in the VDC you want. Then you can go to the default VDC and run ethanalyzer to see your traffic.</p>

<h3>References:</h3>

<p>Using Ethanalyzer<br>
<a href="https://supportforums.cisco.com/docs/DOC-31148">https://supportforums.cisco.com/docs/DOC-31148</a></p>

<p>Understanding wireshark relating to Cisco Catalyst and IOS devices<br>
<a href="http://www.cisco.com/en/US/docs/switches/lan/catalyst3850/software/release/3se/consolidated_guide/configuration_guide/b_consolidated_3850_3se_cg_chapter_01100110.html">http://www.cisco.com/en/US/docs/switches/lan/catalyst3850/software/release/3se/consolidated_guide/configuration_guide/b_consolidated_3850_3se_cg_chapter_01100110.html</a></p>

<p>Using the “monitor capture” command on IOS devices<br>
<a href="http://www.cisco.com/en/US/docs/ios-xml/ios/epc/command/monitor_capture_through_show_monitor_capture.html">http://www.cisco.com/en/US/docs/ios-xml/ios/epc/command/monitor_capture_through_show_monitor_capture.html</a></p>
]]></content>
  </entry>
  
</feed>
